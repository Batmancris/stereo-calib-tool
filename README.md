# 立体视觉标定与测距系统

## 项目概述

这是一个基于 Python 和 OpenCV 的立体视觉系统，主要用于双目相机的标定、图像矫正以及基于视差的距离测量。系统提供了直观的图形用户界面，支持相机预览、视频录制、棋盘格标定、图像矫正和点到点距离测量等功能。

### 主要功能
- 相机预览与视频录制
- 基于棋盘格的相机标定
- 立体图像矫正
- 基于视差的三维距离测量
- 交互式点选择与结果可视化

### 技术栈
- Python 3.9+
- OpenCV
- PyQt5
- NumPy
- FFmpeg

## 目录结构

```
e:\research\0\stero\
├── __pycache__/             # Python 编译缓存
├── calib_tab.py             # 标定功能模块
├── clickable_label.py       # 可点击图像标签组件
├── config.py                # 配置文件
├── ffmpeg_io.py             # FFmpeg 视频处理模块
├── main.py                  # 主程序入口
├── preview_record_tab.py    # 预览和录制功能模块
├── rectify_tab.py           # 矫正和测距功能模块
├── stereo_calibrate_from_video.py  # 从视频标定脚本
├── test.py                  # 测试脚本
├── utils_img.py             # 图像处理工具函数
├── record_*.avi             # 录制的视频文件
├── stereo_calib_*.yaml      # 标定结果文件
└── DECXIN-SM-2930V1 USB摄像模组规格书.pdf  # 相机规格书
```

## 安装和依赖

### 所需依赖

1. **Python 包**：
   - opencv-python (>=4.5.0)
   - numpy
   - pyqt5

2. **外部工具**：
   - FFmpeg：用于相机预览和视频录制

### 安装方法

1. **安装 Python 包**：
   ```bash
   pip install opencv-python numpy pyqt5
   ```

2. **安装 FFmpeg**：
   - 从 [FFmpeg 官网](https://ffmpeg.org/download.html) 下载适合您系统的版本
   - 或使用包管理器安装（如 winget、apt 等）

### 配置说明

在 `config.py` 文件中配置以下参数：

```python
# ===== 你需要改的 =====
FFMPEG_EXE = r"C:\path\to\ffmpeg.exe"  # FFmpeg 可执行文件路径
DEVICE_NAME = "DECXIN Camera"           # 相机设备名称
RECORD_DIR = r"E:\research\0\stero"    # 录制文件保存目录

SBS_W, SBS_H = 3840, 1080  # 相机分辨率（宽x高）
FPS = 30                   # 帧率

PREVIEW_W, PREVIEW_H = 1280, 360  # 预览分辨率
PREVIEW_Q = 7                     # 预览质量

SPLIT_OFFSET = 0  # 分割偏移
SPLIT_GAP = 0     # 分割间隙
# =====================
```

## 使用方法

### 启动应用

```bash
python main.py
```

应用启动后会显示一个包含三个标签页的界面：
1. **预览+录制**：用于相机预览和视频录制
2. **标定**：用于相机标定
3. **Rectify+测距**：用于图像矫正和距离测量

### 预览和录制功能

1. **开始预览**：点击"开始预览"按钮，系统会显示左右相机的实时画面
2. **开始录制**：点击"开始录制"按钮，系统会将视频保存到配置的目录
3. **截图**：点击"截图(预览分辨率)"按钮，系统会保存当前预览画面

### 相机标定流程

1. **准备工作**：
   - 打印一张棋盘格标定板（建议使用 11x8 内角点，30mm 方格）
   - 使用"预览+录制"功能录制一段包含不同角度棋盘格的视频

2. **标定步骤**：
   - 在"标定"标签页中，点击"选择视频"按钮选择录制的视频
   - 设置棋盘格参数：内角点 cols、rows，方格尺寸(mm)
   - 点击"扫描角点"按钮，系统会自动检测视频中的棋盘格角点
   - 点击"一键标定+保存YAML"按钮，系统会计算标定参数并保存为 YAML 文件

### 矫正和测距操作

1. **准备工作**：
   - 使用上述步骤获取标定结果 YAML 文件
   - 准备一段要进行测距的视频

2. **测距步骤**：
   - 在"Rectify+测距"标签页中，点击"选YAML"按钮选择标定结果文件
   - 点击"加载YAML(预计算矫正)"按钮加载标定参数
   - 点击"选视频"按钮选择要分析的视频
   - 点击"打开视频"按钮打开视频文件
   - 播放视频并找到合适的帧，点击"冻结为测距帧"按钮
   - 按顺序点击四个点：A左→A右→B左→B右
   - 输入已知长度(mm)，点击"计算 3D 距离/误差"按钮
   - 系统会显示测量结果和误差

## 技术细节

### 立体视觉原理

立体视觉是利用两台相机从不同角度拍摄同一场景，通过计算对应点的视差来获取深度信息的技术。本系统采用平行双目相机 setup，通过标定获取相机内外参数，然后进行图像矫正，使同名点位于同一水平线上，最后通过视差计算距离。

### 标定算法说明

1. **角点检测**：使用 OpenCV 的 `findChessboardCorners` 或 `findChessboardCornersSB` 检测棋盘格角点
2. **单目标定**：分别对左右相机进行标定，获取内参矩阵和畸变系数
3. **立体标定**：计算两相机之间的旋转矩阵和平移向量
4. **矫正映射**：使用 `stereoRectify` 和 `initUndistortRectifyMap` 计算矫正映射

### 测距计算方法

1. **视差计算**：通过手动选择对应点，计算左右图像中对应点的水平像素差
2. **三维重建**：使用重投影矩阵 Q 将像素坐标和视差转换为三维坐标
3. **距离计算**：计算两个三维点之间的欧氏距离

## 常见问题和解决方案

1. **无法打开相机**：
   - 检查相机是否正确连接
   - 确认 `config.py` 中的 `DEVICE_NAME` 是否正确
   - 确保 FFmpeg 路径正确

2. **标定失败**：
   - 确保棋盘格清晰可见
   - 录制视频时包含足够多的不同角度
   - 检查棋盘格参数设置是否正确

3. **测距误差较大**：
   - 确保标定准确
   - 选择对比度高、纹理丰富的场景
   - 确保对应点选择准确

## 注意事项

1. **相机选择**：建议使用同步性好的双目相机，如 DECXIN Camera
2. **标定板**：使用打印质量好、平整的棋盘格标定板
3. **环境要求**：在光线充足、均匀的环境下进行标定和测距
4. **存储管理**：定期清理录制的视频文件，避免占用过多磁盘空间
5. **FFmpeg 配置**：确保 FFmpeg 版本兼容，建议使用最新版本

## 系统要求

- Windows 10/11
- Python 3.9+
- 至少 4GB 内存
- 支持 OpenGL 的显卡（用于 PyQt5 渲染）
- 可用 USB 3.0 端口连接相机

## 免责声明

本系统仅供研究和教育目的使用，对于商业应用中的准确性和可靠性不做保证。使用时请自行验证测量结果的准确性。
